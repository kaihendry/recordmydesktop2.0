#!/bin/bash -e

if ! test -z "$WAYLAND_DISPLAY"
then
	exec record
	exit
fi

while getopts "mnhv" o
do
	case "$o" in
	(\?) echo "Invalid option: -$OPTARG" >&2 ;;
	(h) less $(readlink -f $(dirname $0))/README.md; exit;;
	(v) verbose="";; # funnily ffmpeg is verbose by default
	(*) break;;
	esac
done
shift $((OPTIND - 1))

lockfile=/tmp/r2d2

if test -f $lockfile
then
	pid=$(awk '{print $1}' $lockfile)
	if kill -0 $pid
	then
		kill -INT $pid
		echo Killed $(cat $lockfile)
		fn=$(awk '{print $2}' $lockfile)
		logger x11captured: $(du -h $fn)
		pkill swcursor
		pkill xcompmgr
		rm $lockfile
		filename=$(dmenu -fn "Terminus (TTF):pixelsize=28" -p "Screencast filename" < /dev/null)
		if test "$filename"
		then
			ofilename="$(dirname $(readlink -f ${fn}))/${filename}.mp4"
			mv -v "$fn" "$ofilename"
			upload "$ofilename"
		fi
		exit
	else
		rm $lockfile
	fi
fi

output="$HOME/recordmydesktop2.0/$(date +%Y-%m-%d)/${1:-$(date +%s)}.mp4"
mkdir -p $(dirname $output)

# Only create RAW file if one does not exist
if test -f "$output"
then
	echo $output already exists
	logger $(basename $0): $output already exists
	exit 1
fi

die() { echo "$@"; exit 1; }
require() { which $1 &> /dev/null; }
for prg in xdpyinfo ffmpeg; do
	require $prg || die "needs ${prg} installed"
done

xcompmgr &
cd /home/hendry/tmp/swcursor/ && ./swcursor &

# https://trac.ffmpeg.org/wiki/Capture/Desktop
# https://raw.githubusercontent.com/gilesp/video-presentation/master/capture.sh
export FFREPORT=file=/tmp/$(basename $output).log
echo Logging to $FFREPORT

ffmpeg -report \
	-f pulse -i default -c:a aac \
	-framerate 30 -f kmsgrab -i - -vaapi_device /dev/dri/renderD128 -filter:v hwmap,scale_vaapi=w=2560:h=1440:format=nv12 -c:v h264_vaapi \
	$output &

echo "$! $(readlink -f $output)" > $lockfile
echo -e "\033[1;34m$0\033[m Capturing $res to $output kill $(awk '{print $1}' $lockfile) to kill capture or run $0 again"
